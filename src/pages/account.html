<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../../resrc/images/misc/favicon.webp" type="image/x-icon">
    <link rel="stylesheet" href="../styles/common.css">
    <link rel="stylesheet" href="../styles/authentication.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <title>Malang | Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD20pmHMSjDirK1CFEz1EIrUJWwqbVLev4",
            authDomain: "malang-auth.firebaseapp.com",
            projectId: "malang-auth",
            storageBucket: "malang-auth.firebasestorage.app",
            messagingSenderId: "522245850115",
            appId: "1:522245850115:web:f8a69e1e021222fa997a36",
            measurementId: "G-GHFQ1YG8WZ"
        };

        // Firebase init
        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Allowed emails
        let allowedEmails = [];
        fetch("/resrc/data/member-emails.json")
            .then(res => res.json())
            .then(data => allowedEmails = data);

        // Helpers
        function updateUI(user) {
            const status = document.getElementById("status");
            const profilePic = document.getElementById("profilePic");

            if (user && allowedEmails.includes(user.email)) {
                showAlert("Login successful", "", "Proceed");
                status.innerText = `Hey ${user.displayName}! ðŸ‘‹`;
                profilePic.src = user.photoURL;
                profilePic.classList.add("profile-pic");
                localStorage.setItem("loggedIn", "true");
            } else {
                status.innerText = user ? "Unauthorised Access Attempt." : "Authentication Required.";
                profilePic.src = "/resrc/images/icons/user.png";
                profilePic.classList.remove("profile-pic");
                localStorage.setItem("loggedIn", "false");
            }
            toggleRestricted();
        }

        // Auth functions
        async function login() {
            try {
                const { user } = await signInWithPopup(auth, provider);
                if (!allowedEmails.includes(user.email)) {
                    vibrate(200);
                    showAlert("Unauthorised Access Attempt.", "Login restricted: Membership with Malang is required.", "Close");
                    await signOut(auth);
                } else {
                    vibrate(50);
                }
                updateUI(user);
            } catch (error) {
                vibrate(50);
                showAlert("Login failed.", error, "OK");
            }
        }

        async function logout() {
            await signOut(auth);
            updateUI(null);
        }

        onAuthStateChanged(auth, updateUI);

        window.login = login;
        window.logout = logout;

        toggleRestricted();

    </script>
</head>

<body>
    <div data-include="../components/nav.html"></div>
    <section>
        <canvas id="gradientCanvas"></canvas>
        <div id="loginForm">
            <h3 id="status">Authentication Required.</h3>
            <div class="restricted">
                <p>You can now access the following tools:</p>
                <a class="long-btn" href="/src/pages/claims.html">Claims</a>
                <a class="long-btn" href="/src/pages/authentication.html">Treasury</a>
                <a class="long-btn" href="/src/pages/redirector.html">Redirector</a>
                <hr>
            </div>
            <button id="loginBtn" class="long-btn" onclick="login()" style="position: relative;"><img
                    src="/resrc/images/icons/google.png" alt="" id="google"
                    style="height: 25px; position: absolute; left: 10px; top:6px;">Sign in with Google</button>
            <button id="logoutBtn" class="long-btn" onclick="logout()">Sign out</button>
        </div>
    </section>
    <script src="../scripts/common.js"></script>
    <script src="../scripts/authentication.js"></script>
</body>

</html>